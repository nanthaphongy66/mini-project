<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WEB GIS - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="./assets/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <span style="font-size: 20px;">üó∫Ô∏è</span>
        <div>WEB GIS - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</div>
      </div>
      <div class="nav">
        <div class="header2" style="background: var(--primary); color: var(--white);">
          üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </div>
        <div class="header2" onclick="window.location.href='addPoint.html'">
          üìç ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î
        </div>
        <div class="header2" onclick="window.location.href='student.html'">
          üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
        </div>
        <div class="header2" onclick="window.location.href='aboutMe.html'">
          üë§ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô
        </div>
        <div class="header3" onclick="window.location.href='index.html'">
          üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </div>
        <div id="welcomeText">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</div>
      </div>
    </div>

    <div class="map-section">
      <div class="controls">
        <div class="text">üéØ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        <select id="searchSelect">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ --</option>
        </select>
        <button id="resetBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</button>
      </div>

      <div id="map"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

    <script>
      // ==========================
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
      // ==========================
      const map = L.map("map", {
        zoomControl: false,
        attributionControl: true
      }).setView([16.5, 100.5], 8);

      L.control.zoom({
        position: 'topright'
      }).addTo(map);

      // ==========================
      // Base Maps
      // ==========================
      const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const satellite = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Satellite",
        }
      );

      const topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
        maxZoom: 17,
        attribution: "Map data: &copy; OpenStreetMap, SRTM | Map style: &copy; OpenTopoMap",
      });

      // ==========================
      // LayerGroup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      // ==========================
      const userPointsLayer = L.layerGroup().addTo(map);

      const userIcon = L.icon({
        iconUrl: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc2626'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3E%3C/svg%3E",
        iconSize: [36, 36],
        iconAnchor: [18, 36],
        popupAnchor: [0, -36],
      });

      let userMarkers = [];

      // ==========================
      // LayerGroup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏ô (API)
      // ==========================
      const rainLayer = L.layerGroup();

      async function loadRainData() {
        try {
          const url = "https://api-v3.thaiwater.net/api/v1/thaiwater30/public/thailand_main_rain?province_code=65";
          const response = await axios.get(url);
          const data = response.data.data;

          const rainIcon = L.icon({
            iconUrl: "assets/img/water.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
          });

          data.forEach((item) => {
            const lat = item.station.tele_station_lat;
            const lon = item.station.tele_station_long;
            const name = item.station.tele_station_name.th;
            const rain = item.rain_24h ?? 0;
            const time = item.rainfall_datetime;
            const province = item.geocode.province_name.th;

            const marker = L.marker([lat, lon], { icon: rainIcon }).bindPopup(`
              <b>${name}</b><br>
              üåßÔ∏è ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô 24 ‡∏ä‡∏°.: <b>${rain} ‡∏°‡∏°.</b><br>
              üïê ‡πÄ‡∏ß‡∏•‡∏≤: ${time}<br>
              üìç ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${province}
            `);

            marker.addTo(rainLayer);
          });
        } catch (error) {
          console.error("Error loading rain data:", error);
        }
      }
      loadRainData();

      // ==========================
      // LayerGroup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (API)
      // ==========================
      const waterLayer = L.layerGroup();

      async function loadWaterData() {
        try {
          const url = "https://api-v3.thaiwater.net/api/v1/thaiwater30/public/waterlevel_load";
          const response = await axios.get(url);
          const data = response.data.waterlevel_data.data;

          const waterIcon = L.icon({
            iconUrl: "assets/img/water-level.png",            
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
          });

          data.forEach((item) => {
            const lat = item.station.tele_station_lat;
            const lon = item.station.tele_station_long;
            const name = item.station.tele_station_name.th;
            const level = item.waterlevel_msl ?? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            const river = item.river_name ?? "-";

            const marker = L.marker([lat, lon], { icon: waterIcon }).bindPopup(`
              <b>${name}</b><br>
              üåä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (MSL): <b>${level} ‡∏°.</b><br>
              üèûÔ∏è ‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥/‡∏Ñ‡∏•‡∏≠‡∏á: ${river}<br>
              üïê ‡πÄ‡∏ß‡∏•‡∏≤: ${item.waterlevel_datetime}
            `);

            marker.addTo(waterLayer);
          });
        } catch (error) {
          console.error("Error loading water data:", error);
        }
      }
      loadWaterData();

      // ==========================
      // LayerGroup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CSV (Landslide Monitoring)
      // ==========================
      const csvLayer = L.layerGroup();

      const csvIcon = L.icon({
        iconUrl: "assets/img/pin-point.png",            
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32],
      });

      Papa.parse("sl_monitoring_05010107.csv", {
        download: true,
        header: true,
        complete: function (results) {
          results.data.forEach((row) => {
            const easting = parseFloat(row.UTM_E);
            const northing = parseFloat(row.UTM_N);

            if (!isNaN(easting) && !isNaN(northing)) {
              const utmProjection = "+proj=utm +zone=47 +datum=WGS84 +units=m +no_defs";
              const wgs84 = "+proj=longlat +datum=WGS84 +no_defs";
              const [lng, lat] = proj4(utmProjection, wgs84, [easting, northing]);

              const marker = L.marker([lat, lng], { icon: csvIcon })
                .bindPopup(`
                  <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ:</b> ${row.STAT_ID || "-"}<br>
                  <b>‡∏ö‡πâ‡∏≤‡∏ô:</b> ${row.BAN || "-"}<br>
                  <b>‡∏ï‡∏≥‡∏ö‡∏•:</b> ${row.TAMBON || "-"}<br>
                  <b>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</b> ${row.DISTRICT || "-"}<br>
                  <b>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</b> ${row.PROVINCE || "-"}<br>
                  <b>‡∏õ‡∏µ:</b> ${row.YEAR || "-"}<br>
                `);
              csvLayer.addLayer(marker);
            }
          });
        },
      });

      // ==========================
      // GeoJSON - ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
      // ==========================
      function popUp(f, l) {
        var out = [];
        if (f.properties) {
          for (key in f.properties) {
            out.push(key + ": " + f.properties[key]);
          }
          l.bindPopup(out.join("<br />"));
        }
      }

      var ThaiProvJSON = new L.GeoJSON.AJAX(["./thailand_province.geojson"], {
        onEachFeature: popUp,
        style: {
          color: '#3b82f6',
          weight: 2,
          fillOpacity: 0.1
        }
      });

      // ==========================
      // GeoServer WMS Layers
      // ==========================
      var road = L.tileLayer.wms(
        "http://localhost:8080/geoserver/agi_students/wms",
        {
          layers: "agi_students:road",
          format: "image/png",
          transparent: true,
        }
      );

      var district = L.tileLayer.wms(
        "http://localhost:8080/geoserver/agi_students/wms",
        {
          layers: "agi_students:district",
          format: "image/png",
          transparent: true,
        }
      );

      // const orthoLayer = L.tileLayer.wms("http://localhost:8080/geoserver/agi_students/wms", {
      //   layers: "agi",
      //   format: "image/png",
      //   transparent: true,
      //   version: "1.1.0",
      // });

      // ==========================
      // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏à‡∏≤‡∏Å Database
      // ==========================
      function updatePopup(marker, id, name, description) {
        marker.bindPopup(`
          <div style="min-width: 250px; font-family: 'Inter', sans-serif;">
            <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 18px; font-weight: 700;">üìç ${name}</h3>
            <p style="margin: 6px 0; color: #64748b; font-size: 14px; line-height: 1.6;">${description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
          </div>
        `);
      }

      async function refreshPoints() {
        try {
          userPointsLayer.clearLayers();
          userMarkers = [];

          const res = await axios.get("./api.php?action=points");
          const points = Array.isArray(res.data) ? res.data : [];

          const select = document.getElementById("searchSelect");
          select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ --</option>';

          points.forEach((p) => {
            const marker = L.marker([p.lat, p.lon], { icon: userIcon });
            updatePopup(marker, p.id, p.name, p.description);
            marker.addTo(userPointsLayer);
            userMarkers.push({ marker: marker, name: p.name, id: p.id });

            const option = document.createElement("option");
            option.value = p.id;
            option.text = `üìç ${p.name}`;
            select.add(option);
          });

          console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${points.length} ‡∏à‡∏∏‡∏î`);
        } catch (error) {
          console.error("Error loading points:", error);
        }
      }

      refreshPoints();

      // ==========================
      // Dropdown: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Marker ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      // ==========================
      document.getElementById("searchSelect").onchange = function () {
        const selectedId = this.value;
        if (!selectedId) return;

        const item = userMarkers.find((x) => x.id == selectedId);
        if (item) {
          map.setView(item.marker.getLatLng(), 14);
          item.marker.openPopup();
        }
      };

      // ==========================
      // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
      // ==========================
      document.getElementById("resetBtn").onclick = function () {
        map.setView([16.5, 100.5], 8);
        document.getElementById("searchSelect").value = "";
        map.closePopup();
      };

      // ==========================
      // Layer Control
      // ==========================
      const baseMaps = {
        "üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô": osm,
        "üõ∞Ô∏è ‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": satellite,
        "‚õ∞Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®": topo,
      };

      const overlayMaps = {
        "üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß": userPointsLayer,
        "üåßÔ∏è ‡∏ù‡∏ô 24 ‡∏ä‡∏°. (API)": rainLayer,
        "üåä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (API)": waterLayer,
        "üó∫Ô∏è ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (GeoJSON)": ThaiProvJSON,
        "‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏î‡∏¥‡∏ô‡∏ñ‡πà‡∏ß‡∏á (CSV)": csvLayer,
        "üõ£Ô∏è ‡∏ñ‡∏ô‡∏ô‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å (WMS)": road,
        "üèõÔ∏è ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (WMS)": district,
        // "üì∏ ‡∏†‡∏≤‡∏û Ortho AGI (WMS)": orthoLayer,
      };

      const layerControl = L.control.layers(baseMaps, overlayMaps, { 
        collapsed: false,
        position: 'topleft'
      }).addTo(map);

      // ==========================
      // GeoServer WFS
      // ==========================
      fetch("get_wfs.php")
        .then(res => res.json())
        .then(data => {
          const geoLayer = L.geoJSON(data, {
            style: { color: "blue", weight: 2, fillOpacity: 0.3 },
            onEachFeature: (feature, layer) => {
              const props = feature.properties;
              let popup = "";
              for (const key in props) {
                popup += `<b>${key}</b>: ${props[key]}<br>`;
              }
              layer.bindPopup(popup);
            }
          });
          layerControl.addOverlay(geoLayer, "üå≥ ‡∏õ‡πà‡∏≤‡∏™‡∏á‡∏ß‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥ (WFS)");
        })
        .catch(err => console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• WFS ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err));

      // ==========================
      // Scale Control
      // ==========================
      L.control.scale({ 
        imperial: false, 
        metric: true,
        position: 'bottomleft'
      }).addTo(map);

      // ==========================
      // Check Login
      // ==========================
      const username = localStorage.getItem("username");
      if (username) {
        document.getElementById("welcomeText").textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${username}!`;
      }

      console.log("‚úÖ Enhanced WEB GIS System ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå");
    </script>
  </body>
</html>